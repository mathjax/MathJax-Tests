import {ParserTest} from './parser-tests.js';
import 'mathjax3/input/tex/newcommand/NewcommandConfiguration.js';

class ParserNewcommandTest extends ParserTest {

  constructor() {
    super();
    this.packages = ['base', 'ams', 'newcommand'];
  }

}

let parserTest = new ParserNewcommandTest();

parserTest.runTest(
  'Newcommand Simple', '\\newcommand{\\sum}{2 + 3}\\sum',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "2"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "+"}],
          "isEmbellished": true},
        {"kind": "mn",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "3"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newcommand Arg', '\\renewcommand{\\sum}[1]{2 #1 3}\\sum{*}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "2"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "∗"}],
          "isEmbellished": true},
        {"kind": "mn",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "3"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newcommand Optional', '\\renewcommand{\\sum}[1][+]{2 #1 3}\\sum\\sum[*]',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "2"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "3"}]},
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "2"}]},
        {"kind": "mo",
          "texClass": 2,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "∗"}],
          "isEmbellished": true},
        {"kind": "mn",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "3"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newcommand Arg Optional', '\\renewcommand{\\sum}[2][+]{2 #1 3 #2 4}\\sum{+}\\sum[*]{+}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "2"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "3"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "4"}]},
        {"kind": "mn",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "2"}]},
        {"kind": "mo",
          "texClass": 2,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "∗"}],
          "isEmbellished": true},
        {"kind": "mn",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "3"}]},
        {"kind": "mo",
          "texClass": 2,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "+"}],
          "isEmbellished": true},
        {"kind": "mn",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "4"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Empty', '\\newenvironment{myHeartEnv}{\\color{purple}{\\heartsuit}\\kern-2.5pt\\color{green}{\\heartsuit}}{\\text{ forever}}\\begin{myHeartEnv}\\end{myHeartEnv}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "purple"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "purple",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "purple",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant":"italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mspace",
         "texClass": 0,
         "attributes": {"width": "-2.5pt"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [],
         "isSpacelike": true},
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "green"},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "mrow",
              "texClass": 0,
              "attributes": {},
              "inherited": {"mathcolor": "green",
                "displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mi",
                  "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "green",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant":"italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "♡"}]}],
              "isInferred": true}]},
        {"kind": "mtext",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": " forever"}],
          "isSpacelike": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Content', '\\newenvironment{myHeartEnv}{\\color{purple}{\\heartsuit}\\kern-2.5pt\\color{green}{\\heartsuit}}{\\text{ forever}}\\begin{myHeartEnv}  2+3\\end{myHeartEnv}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "purple"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "purple",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "purple",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant":"italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mspace",
         "texClass": 0,
         "attributes": {"width": "-2.5pt"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [],
         "isSpacelike": true},
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "green"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "green",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "green",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant":"italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "♡"}]}],
              "isInferred": true}]},
        {"kind": "mn",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "2"}]},
        {"kind": "mo",
          "texClass": 2,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "+"}],
          "isEmbellished": true},
        {"kind": "mn",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "3"}]},
        {"kind": "mtext",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": " forever"}],
          "isSpacelike": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Align', '\\newenvironment{proof}{\\textbf{Proof:}}{\\begin{align} \\blacksquare \\end{align}}\\begin{proof}a=b\\end{proof}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "TeXAtom",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 0},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mtext",
               "texClass": 0,
               "attributes": {"mathvariant": "bold"},
               "inherited": {"displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "Proof:"}],
               "isSpacelike": true}],
            "isInferred": true,
            "isSpacelike": true}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mo",
         "texClass": 3,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "="}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "b"}]},
        {"kind": "mtable",
         "texClass": 0,
         "attributes": {"displaystyle": true,
                        "columnalign": "right left right left right left right left right left right left",
            "columnspacing": "0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em",
            "rowspacing": "3pt"},
          "inherited": {"scriptlevel": 0},
          "properties": {"useHeight": 1},
          "childNodes": [
            {"kind": "mtr",
              "texClass": null,
              "attributes": {},
              "inherited": {"columnalign": "right left right left right left right left right left right left",
                "rowalign": "baseline",
                "displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mtd",
                  "texClass": null,
                  "attributes": {},
                  "inherited": {"columnalign": "right",
                    "rowalign": "baseline",
                    "displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": 0,
                      "attributes": {},
                      "inherited": {"displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "◼"}]}],
                      "isInferred": true}]}]}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Align End', '\\newenvironment{proof}{\\begin{align}\\textbf{Proof:}}{\\end{align}}\\begin{proof}a=b\\end{proof}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mtable",
         "texClass": 0,
         "attributes": {"displaystyle": true,
                        "columnalign": "right left right left right left right left right left right left",
                        "columnspacing": "0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em",
                        "rowspacing": "3pt"},
         "inherited": {"scriptlevel": 0},
         "properties": {"useHeight": 1},
         "childNodes": [
           {"kind": "mtr",
            "texClass": null,
            "attributes": {},
            "inherited": {"columnalign": "right left right left right left right left right left right left",
                          "rowalign": "baseline",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mtd",
               "texClass": null,
               "attributes": {},
               "inherited": {"columnalign": "right",
                             "rowalign": "baseline",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mrow",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                                "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "TeXAtom",
                     "texClass": 0,
                     "attributes": {},
                     "inherited": {"displaystyle": true,
                                   "scriptlevel": 0},
                     "properties": {"texClass": 0},
                     "childNodes": [
                       {"kind": "mrow",
                              "texClass": 0,
                              "attributes": {},
                              "inherited": {"displaystyle": true,
                                "scriptlevel": 0},
                              "properties": {},
                              "childNodes": [
                                {"kind": "mtext",
                                  "texClass": 0,
                                  "attributes": {"mathvariant": "bold"},
                                  "inherited": {"displaystyle": true,
                                    "scriptlevel": 0},
                                  "properties": {},
                                  "childNodes": [
                                    {"kind": "text",
                                      "text": "Proof:"}],
                                  "isSpacelike": true}],
                              "isInferred": true,
                              "isSpacelike": true}]},
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "a"}]},
                        {"kind": "mo",
                          "texClass": 3,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0,
                            "form": "infix"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "="}],
                          "isEmbellished": true},
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "b"}]}],
                      "isInferred": true}]}]}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Align Split', '\\newenvironment{proof}{\\begin{align}\\textbf{Proof:}&}{ \\begin{split} 5 \\end{split}&& \\blacksquare\\end{align}}\\begin{proof}a&=b\\end{proof}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mtable",
         "texClass": 0,
         "attributes": {"displaystyle": true,
                        "columnalign": "right left right left right left right left right left right left",
                        "columnspacing": "0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em",
                        "rowspacing": "3pt"},
         "inherited": {"scriptlevel": 0},
         "properties": {"useHeight": 1},
         "childNodes": [
           {"kind": "mtr",
            "texClass": null,
            "attributes": {},
            "inherited": {"columnalign": "right left right left right left right left right left right left",
                          "rowalign": "baseline",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mtd",
               "texClass": null,
               "attributes": {},
               "inherited": {"columnalign": "right",
                             "rowalign": "baseline",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mrow",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                                "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "TeXAtom",
                     "texClass": 0,
                     "attributes": {},
                     "inherited": {"displaystyle": true,
                                   "scriptlevel": 0},
                     "properties": {"texClass": 0},
                     "childNodes": [
                       {"kind": "mrow",
                        "texClass": 0,
                        "attributes": {},
                        "inherited": {"displaystyle": true,
                                      "scriptlevel": 0},
                        "properties": {},
                        "childNodes": [
                          {"kind": "mtext",
                           "texClass": 0,
                           "attributes": {"mathvariant": "bold"},
                           "inherited": {"displaystyle": true,
                                         "scriptlevel": 0},
                           "properties": {},
                           "childNodes": [
                             {"kind": "text",
                              "text": "Proof:"}],
                           "isSpacelike": true}],
                        "isInferred": true,
                        "isSpacelike": true}]}],
                  "isInferred": true}]},
              {"kind": "mtd",
               "texClass": null,
               "attributes": {},
               "inherited": {"columnalign": "left",
                             "rowalign": "baseline",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mrow",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                                "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mi",
                     "texClass": 0,
                     "attributes": {},
                     "inherited": {"displaystyle": true,
                                   "scriptlevel": 0,
                                   "mathvariant": "italic"},
                     "properties": {},
                     "childNodes": [
                       {"kind": "text",
                        "text": "a"}]}],
                  "isInferred": true}]},
              {"kind": "mtd",
               "texClass": null,
               "attributes": {},
               "inherited": {"columnalign": "right",
                             "rowalign": "baseline",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": 0,
                      "attributes": {},
                      "inherited": {"displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0},
                          "properties": {},
                          "childNodes": []},
                        {"kind": "mo",
                          "texClass": 3,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0,
                            "form": "infix"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "="}],
                          "isEmbellished": true},
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "b"}]},
                        {"kind": "mtable",
                          "texClass": 0,
                          "attributes": {"displaystyle": true,
                            "columnalign": "right left",
                            "columnspacing": "0em",
                            "rowspacing": "3pt"},
                          "inherited": {"columnalign": "right",
                            "rowalign": "baseline",
                            "scriptlevel": 0},
                          "properties": {"useHeight": 1},
                          "childNodes": [
                            {"kind": "mtr",
                              "texClass": null,
                              "attributes": {},
                              "inherited": {"columnalign": "right left",
                                "rowalign": "baseline",
                                "displaystyle": true,
                                "scriptlevel": 0},
                              "properties": {},
                              "childNodes": [
                                {"kind": "mtd",
                                  "texClass": null,
                                  "attributes": {},
                                  "inherited": {"columnalign": "right",
                                    "rowalign": "baseline",
                                    "displaystyle": true,
                                    "scriptlevel": 0},
                                  "properties": {},
                                  "childNodes": [
                                    {"kind": "mrow",
                                      "texClass": 0,
                                      "attributes": {},
                                      "inherited": {"displaystyle": true,
                                        "scriptlevel": 0},
                                      "properties": {},
                                      "childNodes": [
                                        {"kind": "mn",
                                          "texClass": 0,
                                          "attributes": {},
                                          "inherited": {"displaystyle": true,
                                            "scriptlevel": 0},
                                          "properties": {},
                                          "childNodes": [
                                            {"kind": "text",
                                              "text": "5"}]}],
                                      "isInferred": true}]}]}]}],
                      "isInferred": true}]},
                {"kind": "mtd",
                  "texClass": null,
                  "attributes": {},
                  "inherited": {"columnalign": "left",
                    "rowalign": "baseline",
                    "displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": null,
                      "attributes": {},
                      "inherited": {"displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [],
                      "isInferred": true,
                      "isSpacelike": true}]},
                {"kind": "mtd",
                  "texClass": null,
                  "attributes": {},
                  "inherited": {"columnalign": "right",
                    "rowalign": "baseline",
                    "displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": 0,
                      "attributes": {},
                      "inherited": {"displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {},
                          "inherited": {"displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "◼"}]}],
                      "isInferred": true}]}]}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Optional', '\\newenvironment{argument}[1][a]{\\textbf{Argument #1:}}{aa}\\begin{argument}[c]b\\end{argument}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "TeXAtom",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 0},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mtext",
               "texClass": 0,
               "attributes": {"mathvariant": "bold"},
               "inherited": {"displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "Argument c:"}],
               "isSpacelike": true}],
            "isInferred": true,
            "isSpacelike": true}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "b"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "a"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "a"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Arg Optional', '\\renewenvironment{argument}[2][a]{\\textbf{Argument #1(#2):}}{aa}\\begin{argument}[c]{3}b\\end{argument}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "TeXAtom",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 0},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mtext",
               "texClass": 0,
               "attributes": {"mathvariant": "bold"},
               "inherited": {"displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "Argument c(3):"}],
               "isSpacelike": true}],
            "isInferred": true,
            "isSpacelike": true}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "b"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "a"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "a"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Def Double Let', '\\def\\bar{h}\\let\\fooi\\bar\\def\\fooii{\\bar}\\fooi +\\fooii\\def\\bar{g}\\fooi +\\fooii',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant":"italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "h"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant":"italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "h"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
          "inherited": {"displaystyle": true,
                        "scriptlevel": 0,
                        "mathvariant":"italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "h"}]},
        {"kind": "mo",
          "texClass": 2,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "+"}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
                        "scriptlevel": 0,
                        "mathvariant":"italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "g"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Def ReDef', '\\def\\foo{a + b}\\foo\\def\\foo#1{a #1 b}\\foo{-}\\def\\foo#1#2{#2 #1 b}\\foo{-}{x}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "b"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "−"}],
         "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "b"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "x"}]},
        {"kind": "mo",
          "texClass": 2,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "−"}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "b"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Bar', '\\let\\b\\lvert\\let\\lvert\\langle\\vert\\b\\lvert',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mo",
         "texClass": 0,
         "attributes": {"fence": false,
                        "stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "prefix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {"texClass": 0},
         "childNodes": [
           {"kind": "text",
            "text": "|"}],
         "isEmbellished": true},
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"fence": false,
                        "stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
            "symmetric": true},
          "properties": {"texClass": 4},
          "childNodes": [
            {"kind": "text",
              "text": "|"}],
          "isEmbellished": true},
        {"kind": "mo",
          "texClass": 4,
          "attributes": {"fence": false,
            "stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "postfix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "⟨"}],
          "isEmbellished": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Brace Equal', '\\let\\be={ \\be a}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "TeXAtom",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mi",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0,
                    "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "a"}]}],
              "isInferred": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Brace', '\\let\\be{ \\be a}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "TeXAtom",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mi",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0,
                    "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "a"}]}],
              "isInferred": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Caret', '\\let\\car^ a\\car b',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "msup",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mi",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0,
                          "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "a"}]},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": false,
                "scriptlevel": 1,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "b"}]}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Brace Delim', '\\let\\lb=\\{ \\lb \\frac{1}{2} \\}',
  {"kind": "math",
   "texClass": 4,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 4,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"fence": false,
                        "stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "prefix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "{"}],
         "isEmbellished": true},
        {"kind": "mfrac",
         "texClass": null,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mn",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": false,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "text",
                  "text": "1"}]},
            {"kind": "mn",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": false,
                "scriptlevel": 0},
              "properties": {"texprimestyle": true},
              "childNodes": [
                {"kind": "text",
                  "text": "2"}]}]},
        {"kind": "mo",
          "texClass": 5,
          "attributes": {"fence": false,
            "stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "postfix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "}"}],
          "isEmbellished": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Paren Delim', '\\let\\lb( \\lb \\frac{1}{2})',
  {"kind": "math",
   "texClass": 4,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 4,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"fence": false,
                        "stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "prefix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "("}],
         "isEmbellished": true},
        {"kind": "mfrac",
         "texClass": null,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mn",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": false,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
                {"kind": "text",
                  "text": "1"}]},
            {"kind": "mn",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": false,
                "scriptlevel": 0},
              "properties": {"texprimestyle": true},
              "childNodes": [
                {"kind": "text",
                  "text": "2"}]}]},
        {"kind": "mo",
          "texClass": 5,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "postfix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": ")"}],
          "isEmbellished": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Relet', '\\let\\al\\alpha\\al\\alpha\\let\\al\\aleph\\al\\alpha',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "α"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "α"}]},
        {"kind": "mi",
         "texClass": 0,
          "attributes": {"mathvariant": "normal"},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "ℵ"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "α"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Let', '\\let\\al\\alpha\\al\\alpha\\let\\alpha\\beta\\al\\alpha',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "α"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "α"}]},
        {"kind": "mi",
         "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "α"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "β"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Def Let', '\\def\\bar[#1]#2{#1 + #2}\\bar[a]{b}\\let\\foo\\bar\\foo[c]{d}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "b"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "c"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
                        "scriptlevel": 0,
                        "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
             "text": "d"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newcommand Let', '\\newcommand{\\bar}[2][1]{#1 + #2}\\bar[a]{b}\\let\\foo\\bar\\foo[c]{d}',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "b"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "c"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "+"}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "d"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Circular Macro', '\\let\\kk\\alpha\\kk\\let\\rr\\beta\\rr\\let\\rr\\kk\\let\\kk\\beta\\kk\\rr',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant":"italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "α"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant":"italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "β"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
                        "scriptlevel": 0,
                       "mathvariant":"italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "β"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
                        "scriptlevel": 0,
                       "mathvariant":"italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "α"}]}],
      "isInferred": true}]}
);


// The following did not work in MJ2.
parserTest.runTest(
  'Let Bar Stretchy', '\\let\\b\\lvert\\let\\lvert\\langle\\left\\b q \\right\\lvert',
  {"kind": "math",
   "texClass": 7,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 7,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mrow",
         "texClass": 7,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"open": "|",
                        "close": "⟨",
                        "texClass": 7},
         "childNodes": [
           {"kind": "mo",
            "texClass": 4,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0,
                          "form": "prefix",
                          "fence": true,
                          "stretchy": true,
                          "symmetric": true},
            "properties": {"texClass": 4},
            "childNodes": [
              {"kind": "text",
               "text": "|"}],
            "isEmbellished": true},
           {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "q"}]},
            {"kind": "mo",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "form": "postfix",
                "fence": true,
                "stretchy": true,
                "symmetric": true},
              "properties": {"texClass": 5},
              "childNodes": [
                {"kind": "text",
                  "text": "⟨"}],
              "isEmbellished": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Brace Equal Stretchy', '\\let\\lb=\\{\\left\\lb \\frac{1}{2} \\right\\}',
  {"kind": "math",
   "texClass": 7,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 7,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mrow",
         "texClass": 7,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"open": "{",
                        "close": "}",
                        "texClass": 7},
         "childNodes": [
           {"kind": "mo",
            "texClass": 4,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0,
                          "form": "prefix",
                          "fence": true,
                          "stretchy": true,
                          "symmetric": true},
            "properties": {"texClass": 4},
            "childNodes": [
              {"kind": "text",
               "text": "{"}],
            "isEmbellished": true},
           {"kind": "mfrac",
            "texClass": null,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mn",
               "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": false,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "1"}]},
                {"kind": "mn",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": false,
                    "scriptlevel": 0},
                  "properties": {"texprimestyle": true},
                  "childNodes": [
                    {"kind": "text",
                      "text": "2"}]}]},
            {"kind": "mo",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "form": "postfix",
                "fence": true,
                "stretchy": true,
                "symmetric": true},
              "properties": {"texClass": 5},
              "childNodes": [
                {"kind": "text",
                  "text": "}"}],
              "isEmbellished": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Paren Stretchy', '\\let\\lb( \\left\\lb \\frac{1}{2} \\right)',
  {"kind": "math",
   "texClass": 7,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 7,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mrow",
         "texClass": 7,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"open": "(",
                        "close": ")",
                        "texClass": 7},
         "childNodes": [
           {"kind": "mo",
            "texClass": 4,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0,
                          "form": "prefix",
                          "fence": true,
                          "stretchy": true,
                          "symmetric": true},
            "properties": {"texClass": 4},
            "childNodes": [
              {"kind": "text",
               "text": "("}],
            "isEmbellished": true},
           {"kind": "mfrac",
            "texClass": null,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mn",
               "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": false,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "1"}]},
                {"kind": "mn",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": false,
                    "scriptlevel": 0},
                  "properties": {"texprimestyle": true},
                  "childNodes": [
                    {"kind": "text",
                      "text": "2"}]}]},
            {"kind": "mo",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "form": "postfix",
                "fence": true,
                "stretchy": true,
                "symmetric": true},
              "properties": {"texClass": 5},
              "childNodes": [
                {"kind": "text",
                  "text": ")"}],
              "isEmbellished": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Fn', '\\let\\ll\\sin\\ll(x)',
  {"kind": "math",
   "texClass": 1,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 1,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 1,
                        "fnOP": true},
         "childNodes": [
           {"kind": "text",
            "text": "sin"}]},
        {"kind": "mo",
         "texClass": -1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {"texClass": -1},
         "childNodes": [
           {"kind": "text",
            "text": "⁡"}],
         "isEmbellished": true},
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
            {"kind": "text",
              "text": "("}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "x"}]},
        {"kind": "mo",
          "texClass": 5,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "postfix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": ")"}],
          "isEmbellished": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Fn Double', '\\let\\ll\\sin\\ll(x)\\let\\rr\\ll\\let\\ll\\cos\\rr(x)\\ll(x)',
  {"kind": "math",
   "texClass": 1,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 1,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 1,
                        "fnOP": true},
         "childNodes": [
           {"kind": "text",
            "text": "sin"}]},
        {"kind": "mo",
         "texClass": -1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {"texClass": -1},
         "childNodes": [
           {"kind": "text",
            "text": "⁡"}],
         "isEmbellished": true},
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "("}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "x"}]},
        {"kind": "mo",
         "texClass": 5,
         "attributes": {"stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": ")"}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 1,
                        "fnOP": true},
         "childNodes": [
           {"kind": "text",
            "text": "sin"}]},
        {"kind": "mo",
         "texClass": -1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {"texClass": -1},
         "childNodes": [
           {"kind": "text",
            "text": "⁡"}],
         "isEmbellished": true},
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "("}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "x"}]},
        {"kind": "mo",
          "texClass": 5,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": ")"}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 1,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {"texClass": 1,
            "fnOP": true},
          "childNodes": [
            {"kind": "text",
              "text": "cos"}]},
        {"kind": "mo",
          "texClass": -1,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {"texClass": -1},
          "childNodes": [
            {"kind": "text",
              "text": "⁡"}],
          "isEmbellished": true},
        {"kind": "mo",
          "texClass": 4,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "("}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "x"}]},
        {"kind": "mo",
          "texClass": 5,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "postfix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": ")"}],
          "isEmbellished": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Fn Circular', '\\let\\save\\sin\\let\\sin\\cos\\let\\cos\\tan\\let\\tan\\save\\sin(x)\\cos(x)\\tan(x)',
  {"kind": "math",
   "texClass": 1,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 1,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 1,
                        "fnOP": true},
         "childNodes": [
           {"kind": "text",
            "text": "cos"}]},
        {"kind": "mo",
         "texClass": -1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {"texClass": -1},
         "childNodes": [
           {"kind": "text",
            "text": "⁡"}],
         "isEmbellished": true},
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "("}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "x"}]},
        {"kind": "mo",
         "texClass": 5,
         "attributes": {"stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": ")"}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"texClass": 1,
                        "fnOP": true},
         "childNodes": [
           {"kind": "text",
            "text": "tan"}]},
        {"kind": "mo",
         "texClass": -1,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
         "properties": {"texClass": -1},
         "childNodes": [
           {"kind": "text",
            "text": "⁡"}],
         "isEmbellished": true},
        {"kind": "mo",
         "texClass": 4,
         "attributes": {"stretchy": false},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix",
                       "fence": true,
                       "stretchy": true,
                       "symmetric": true},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "("}],
         "isEmbellished": true},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "x"}]},
        {"kind": "mo",
          "texClass": 5,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": ")"}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 1,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {"texClass": 1,
            "fnOP": true},
          "childNodes": [
            {"kind": "text",
              "text": "sin"}]},
        {"kind": "mo",
          "texClass": -1,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {"texClass": -1},
          "childNodes": [
            {"kind": "text",
              "text": "⁡"}],
          "isEmbellished": true},
        {"kind": "mo",
          "texClass": 4,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "("}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "x"}]},
        {"kind": "mo",
          "texClass": 5,
          "attributes": {"stretchy": false},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "postfix",
            "fence": true,
            "stretchy": true,
            "symmetric": true},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": ")"}],
          "isEmbellished": true}],
      "isInferred": true}]}
);


parserTest.runTest(
  'Let Paren Circular', '\\let\\lp(\\let\\rp)\\let\\mp\\rp\\left\\lp \\frac{a}{b}\\middle\\mp c \\right\\rp',
  {"kind": "math",
   "texClass": 7,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 7,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mrow",
         "texClass": 7,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"open": "(",
                        "close": ")",
                        "texClass": 7},
         "childNodes": [
           {"kind": "mo",
            "texClass": 4,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0,
                          "form": "prefix",
                          "fence": true,
                          "stretchy": true,
                          "symmetric": true},
            "properties": {"texClass": 4},
            "childNodes": [
              {"kind": "text",
               "text": "("}],
            "isEmbellished": true},
           {"kind": "mfrac",
            "texClass": null,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {},
               "inherited": {"displaystyle": false,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "a"}]},
              {"kind": "mi",
               "texClass": 0,
               "attributes": {},
               "inherited": {"displaystyle": false,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {"texprimestyle": true},
               "childNodes": [
                 {"kind": "text",
                  "text": "b"}]}]},
           {"kind": "TeXAtom",
            "texClass": 5,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {"texClass": 5},
            "childNodes": [
              {"kind": "mrow",
               "texClass": null,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [],
                  "isInferred": true,
                  "isSpacelike": true}]},
            {"kind": "mo",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "form": "infix",
                "fence": true,
                "stretchy": true,
                "symmetric": true},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": ")"}],
              "isEmbellished": true},
            {"kind": "TeXAtom",
              "texClass": 4,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {"texClass": 4},
              "childNodes": [
                {"kind": "mrow",
                  "texClass": null,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [],
                  "isInferred": true,
                  "isSpacelike": true}]},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "c"}]},
            {"kind": "mo",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "form": "postfix",
                "fence": true,
                "stretchy": true,
                "symmetric": true},
              "properties": {"texClass": 5},
              "childNodes": [
                {"kind": "text",
                  "text": ")"}],
              "isEmbellished": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Angle Circular', '\\let\\lp\\langle\\let\\rp\\rangle\\let\\mp\\rp\\left\\lp \\frac{a}{b}\\middle\\mp c \\right\\rp',
  {"kind": "math",
   "texClass": 7,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 7,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mrow",
         "texClass": 7,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"open": "⟨",
                        "close": "⟩",
                        "texClass": 7},
         "childNodes": [
           {"kind": "mo",
            "texClass": 4,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0,
                          "form": "prefix",
                          "fence": true,
                          "stretchy": true,
                          "symmetric": true},
            "properties": {"texClass": 4},
            "childNodes": [
              {"kind": "text",
               "text": "⟨"}],
            "isEmbellished": true},
           {"kind": "mfrac",
            "texClass": null,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {},
               "inherited": {"displaystyle": false,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "a"}]},
              {"kind": "mi",
               "texClass": 0,
               "attributes": {},
               "inherited": {"displaystyle": false,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {"texprimestyle": true},
               "childNodes": [
                 {"kind": "text",
                  "text": "b"}]}]},
           {"kind": "TeXAtom",
            "texClass": 5,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {"texClass": 5},
            "childNodes": [
              {"kind": "mrow",
               "texClass": null,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [],
                  "isInferred": true,
                  "isSpacelike": true}]},
            {"kind": "mo",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "form": "infix",
                "fence": true,
                "stretchy": true,
                "symmetric": true},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "⟩"}],
              "isEmbellished": true},
            {"kind": "TeXAtom",
              "texClass": 4,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {"texClass": 4},
              "childNodes": [
                {"kind": "mrow",
                  "texClass": null,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [],
                  "isInferred": true,
                  "isSpacelike": true}]},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "c"}]},
            {"kind": "mo",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "form": "postfix",
                "fence": true,
                "stretchy": true,
                "symmetric": true},
              "properties": {"texClass": 5},
              "childNodes": [
                {"kind": "text",
                  "text": "⟩"}],
              "isEmbellished": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Let Circular Character', '\\let\\a a\\let\\b b\\a \\b\\let\\c\\a\\let\\a c\\c \\a\\let\\d=\\c\\let\\c\\b\\d \\c',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "b"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "c"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "a"}]},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "b"}]}],
      "isInferred": true}]}
);


parserTest.runTest(
  'Let Overwrite Sqrt Choose', '\\let\\sqrt\\choose a\\sqrt b',
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mrow",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {"open": "(",
                        "close": ")",
                        "texClass": 0},
         "childNodes": [
           {"kind": "TeXAtom",
            "texClass": 4,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {"texClass": 4},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 4,
               "attributes": {},
               "inherited": {"displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mo",
                  "texClass": 4,
                  "attributes": {"minsize": "2.047em",
                                 "maxsize": "2.047em"},
                  "inherited": {"displaystyle": true,
                                "scriptlevel": 0,
                                "form": "infix",
                                "fence": true,
                                "stretchy": true,
                                "symmetric": true},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                     "text": "("}],
                  "isEmbellished": true}],
               "isInferred": true,
               "isEmbellished": true}],
            "isEmbellished": true},
           {"kind": "mfrac",
            "texClass": null,
            "attributes": {"linethickness": 0},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {"withDelims": true},
            "childNodes": [
                {"kind": "mi",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": false,
                    "scriptlevel": 0,
                    "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "a"}]},
                {"kind": "mi",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": false,
                    "scriptlevel": 0,
                    "mathvariant": "italic"},
                  "properties": {"texprimestyle": true},
                  "childNodes": [
                    {"kind": "text",
                      "text": "b"}]}]},
            {"kind": "TeXAtom",
              "texClass": 5,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {"texClass": 5},
              "childNodes": [
                {"kind": "mrow",
                  "texClass": 5,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mo",
                      "texClass": 5,
                      "attributes": {"minsize": "2.047em",
                        "maxsize": "2.047em"},
                      "inherited": {"displaystyle": true,
                        "scriptlevel": 0,
                        "form": "infix",
                        "fence": true,
                        "stretchy": true,
                        "symmetric": true},
                      "properties": {},
                      "childNodes": [
                        {"kind": "text",
                          "text": ")"}],
                      "isEmbellished": true}],
                  "isInferred": true,
                  "isEmbellished": true}],
              "isEmbellished": true}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Def Optional Brace', '\\def\\bar[#1]#2{#1 + #2}\\bar[{a}]{b}', 
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mi",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "mathvariant": "italic"},
         "properties": {},
         "childNodes": [
           {"kind": "text",
            "text": "a"}]},
        {"kind": "mo",
         "texClass": 2,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0,
                       "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "+"}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "b"}]}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Def Options CS', '\\def\\bar[#1]#2{#1 + #2}\\bar[\\sqrt{2}]{b}', 
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "msqrt",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {"texprimestyle": true},
            "childNodes": [
              {"kind": "mn",
               "texClass": 0,
               "attributes": {},
               "inherited": {"displaystyle": true,
                             "scriptlevel": 0},
               "properties": {"texprimestyle": true},
               "childNodes": [
                 {"kind": "text",
                      "text": "2"}]}],
              "isInferred": true}]},
        {"kind": "mo",
          "texClass": 2,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "form": "infix"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "+"}],
          "isEmbellished": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "b"}]}],
      "isInferred": true}]}
);


parserTest.runTest(
  'Newenvironment Nested Double', '\\newenvironment{myHeartEnv}{\\color{purple}{\\heartsuit}\\kern-2.5pt\\color{green}{\\heartsuit}}{\\text{ forever}}\\newenvironment{yourHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\begin{myHeartEnv}\\begin{yourHeartEnv}a\\end{yourHeartEnv}\\end{myHeartEnv}', 
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "purple"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "purple",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "purple",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mspace",
         "texClass": 0,
         "attributes": {"width": "-2.5pt"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [],
         "isSpacelike": true},
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "green"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "green",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "green",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mrow",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mstyle",
            "texClass": 0,
            "attributes": {"mathcolor": "blue"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 0,
               "attributes": {},
               "inherited": {"mathcolor": "blue",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mi",
                      "texClass": 0,
                      "attributes": {"mathvariant": "normal"},
                      "inherited": {"mathcolor": "blue",
                        "displaystyle": true,
                        "scriptlevel": 0,
                        "mathvariant": "italic"},
                      "properties": {},
                      "childNodes": [
                        {"kind": "text",
                          "text": "♡"}]}],
                  "isInferred": true}]},
            {"kind": "mspace",
              "texClass": 0,
              "attributes": {"width": "-2.5pt"},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [],
              "isSpacelike": true},
            {"kind": "mstyle",
              "texClass": 0,
              "attributes": {"mathcolor": "black"},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mrow",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"mathcolor": "black",
                    "displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mi",
                      "texClass": 0,
                      "attributes": {"mathvariant": "normal"},
                      "inherited": {"mathcolor": "black",
                        "displaystyle": true,
                        "scriptlevel": 0,
                        "mathvariant": "italic"},
                      "properties": {},
                      "childNodes": [
                        {"kind": "text",
                          "text": "♡"}]}],
                  "isInferred": true}]},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "a"}]},
            {"kind": "mtext",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": " never"}],
              "isSpacelike": true}],
          "isInferred": true},
        {"kind": "mtext",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": " forever"}],
          "isSpacelike": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Nested Double 2', '\\newenvironment{myHeartEnv}{\\color{purple}{\\heartsuit}\\kern-2.5pt\\color{green}{\\heartsuit}}{\\text{ forever}}\\newenvironment{yourHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\newenvironment{theirHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\begin{myHeartEnv}\\begin{yourHeartEnv}a\\end{yourHeartEnv}\\begin{theirHeartEnv}b\\end{theirHeartEnv}\\end{myHeartEnv}', 
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "purple"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "purple",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "purple",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mspace",
         "texClass": 0,
         "attributes": {"width": "-2.5pt"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [],
         "isSpacelike": true},
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "green"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "green",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "green",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mrow",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mstyle",
            "texClass": 0,
            "attributes": {"mathcolor": "blue"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 0,
               "attributes": {},
               "inherited": {"mathcolor": "blue",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mi",
                  "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "blue",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                     "text": "♡"}]}],
               "isInferred": true}]},
           {"kind": "mspace",
            "texClass": 0,
            "attributes": {"width": "-2.5pt"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [],
            "isSpacelike": true},
           {"kind": "mstyle",
            "texClass": 0,
            "attributes": {"mathcolor": "black"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 0,
               "attributes": {},
               "inherited": {"mathcolor": "black",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mi",
                  "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "black",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant": "italic"},
                  "properties": {},
                      "childNodes": [
                        {"kind": "text",
                          "text": "♡"}]}],
                  "isInferred": true}]},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "a"}]},
            {"kind": "mtext",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": " never"}],
              "isSpacelike": true}],
          "isInferred": true},
        {"kind": "mrow",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "mstyle",
              "texClass": 0,
              "attributes": {"mathcolor": "blue"},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mrow",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"mathcolor": "blue",
                    "displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mi",
                      "texClass": 0,
                      "attributes": {"mathvariant": "normal"},
                      "inherited": {"mathcolor": "blue",
                        "displaystyle": true,
                        "scriptlevel": 0,
                        "mathvariant": "italic"},
                      "properties": {},
                      "childNodes": [
                        {"kind": "text",
                          "text": "♡"}]}],
                  "isInferred": true}]},
            {"kind": "mspace",
              "texClass": 0,
              "attributes": {"width": "-2.5pt"},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [],
              "isSpacelike": true},
            {"kind": "mstyle",
              "texClass": 0,
              "attributes": {"mathcolor": "black"},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mrow",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"mathcolor": "black",
                    "displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mi",
                      "texClass": 0,
                      "attributes": {"mathvariant": "normal"},
                      "inherited": {"mathcolor": "black",
                        "displaystyle": true,
                        "scriptlevel": 0,
                        "mathvariant": "italic"},
                      "properties": {},
                      "childNodes": [
                        {"kind": "text",
                          "text": "♡"}]}],
                  "isInferred": true}]},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "b"}]},
            {"kind": "mtext",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": " never"}],
              "isSpacelike": true}],
          "isInferred": true},
        {"kind": "mtext",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": " forever"}],
          "isSpacelike": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Nested Triple', '\\newenvironment{myHeartEnv}{\\color{purple}{\\heartsuit}\\kern-2.5pt\\color{green}{\\heartsuit}}{\\text{ forever}}\\newenvironment{yourHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\newenvironment{theirHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\begin{myHeartEnv}\\begin{yourHeartEnv}a\\begin{theirHeartEnv}b\\end{theirHeartEnv}\\end{yourHeartEnv}\\end{myHeartEnv}', 
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "purple"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "purple",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "purple",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mspace",
         "texClass": 0,
         "attributes": {"width": "-2.5pt"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [],
         "isSpacelike": true},
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "green"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "green",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "green",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mrow",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mstyle",
            "texClass": 0,
            "attributes": {"mathcolor": "blue"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 0,
               "attributes": {},
               "inherited": {"mathcolor": "blue",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mi",
                  "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "blue",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                     "text": "♡"}]}],
               "isInferred": true}]},
           {"kind": "mspace",
            "texClass": 0,
            "attributes": {"width": "-2.5pt"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [],
            "isSpacelike": true},
           {"kind": "mstyle",
            "texClass": 0,
            "attributes": {"mathcolor": "black"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 0,
               "attributes": {},
               "inherited": {"mathcolor": "black",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mi",
                  "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "black",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant": "italic"},
                  "properties": {},
                      "childNodes": [
                        {"kind": "text",
                          "text": "♡"}]}],
                  "isInferred": true}]},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "a"}]},
            {"kind": "mrow",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mstyle",
                  "texClass": 0,
                  "attributes": {"mathcolor": "blue"},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": 0,
                      "attributes": {},
                      "inherited": {"mathcolor": "blue",
                        "displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {"mathvariant": "normal"},
                          "inherited": {"mathcolor": "blue",
                            "displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "♡"}]}],
                      "isInferred": true}]},
                {"kind": "mspace",
                  "texClass": 0,
                  "attributes": {"width": "-2.5pt"},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [],
                  "isSpacelike": true},
                {"kind": "mstyle",
                  "texClass": 0,
                  "attributes": {"mathcolor": "black"},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": 0,
                      "attributes": {},
                      "inherited": {"mathcolor": "black",
                        "displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {"mathvariant": "normal"},
                          "inherited": {"mathcolor": "black",
                            "displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "♡"}]}],
                      "isInferred": true}]},
                {"kind": "mi",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0,
                    "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "b"}]},
                {"kind": "mtext",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": " never"}],
                  "isSpacelike": true}],
              "isInferred": true},
            {"kind": "mtext",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": " never"}],
              "isSpacelike": true}],
          "isInferred": true},
        {"kind": "mtext",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": " forever"}],
          "isSpacelike": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Nested Triple Text', '\\newenvironment{myHeartEnv}{\\color{purple}{\\heartsuit}\\kern-2.5pt\\color{green}{\\heartsuit}}{\\text{ forever}}\\newenvironment{yourHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\newenvironment{theirHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\begin{myHeartEnv}\\begin{yourHeartEnv}a\\begin{theirHeartEnv}b\\end{theirHeartEnv}c\\end{yourHeartEnv}d\\end{myHeartEnv}', 
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "purple"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "purple",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "purple",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mspace",
         "texClass": 0,
         "attributes": {"width": "-2.5pt"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [],
         "isSpacelike": true},
        {"kind": "mstyle",
         "texClass": 0,
         "attributes": {"mathcolor": "green"},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": 0,
            "attributes": {},
            "inherited": {"mathcolor": "green",
                          "displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mi",
               "texClass": 0,
               "attributes": {"mathvariant": "normal"},
               "inherited": {"mathcolor": "green",
                             "displaystyle": true,
                             "scriptlevel": 0,
                             "mathvariant": "italic"},
               "properties": {},
               "childNodes": [
                 {"kind": "text",
                  "text": "♡"}]}],
            "isInferred": true}]},
        {"kind": "mrow",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mstyle",
            "texClass": 0,
            "attributes": {"mathcolor": "blue"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 0,
               "attributes": {},
               "inherited": {"mathcolor": "blue",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mi",
                  "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "blue",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                     "text": "♡"}]}],
               "isInferred": true}]},
           {"kind": "mspace",
            "texClass": 0,
            "attributes": {"width": "-2.5pt"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [],
            "isSpacelike": true},
           {"kind": "mstyle",
            "texClass": 0,
            "attributes": {"mathcolor": "black"},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mrow",
               "texClass": 0,
               "attributes": {},
               "inherited": {"mathcolor": "black",
                             "displaystyle": true,
                             "scriptlevel": 0},
               "properties": {},
               "childNodes": [
                 {"kind": "mi",
                  "texClass": 0,
                  "attributes": {"mathvariant": "normal"},
                  "inherited": {"mathcolor": "black",
                                "displaystyle": true,
                                "scriptlevel": 0,
                                "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                     "text": "♡"}]}],
               "isInferred": true}]},
           {"kind": "mi",
            "texClass": 0,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "a"}]},
            {"kind": "mrow",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "mstyle",
                  "texClass": 0,
                  "attributes": {"mathcolor": "blue"},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": 0,
                      "attributes": {},
                      "inherited": {"mathcolor": "blue",
                        "displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {"mathvariant": "normal"},
                          "inherited": {"mathcolor": "blue",
                            "displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "♡"}]}],
                      "isInferred": true}]},
                {"kind": "mspace",
                  "texClass": 0,
                  "attributes": {"width": "-2.5pt"},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [],
                  "isSpacelike": true},
                {"kind": "mstyle",
                  "texClass": 0,
                  "attributes": {"mathcolor": "black"},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "mrow",
                      "texClass": 0,
                      "attributes": {},
                      "inherited": {"mathcolor": "black",
                        "displaystyle": true,
                        "scriptlevel": 0},
                      "properties": {},
                      "childNodes": [
                        {"kind": "mi",
                          "texClass": 0,
                          "attributes": {"mathvariant": "normal"},
                          "inherited": {"mathcolor": "black",
                            "displaystyle": true,
                            "scriptlevel": 0,
                            "mathvariant": "italic"},
                          "properties": {},
                          "childNodes": [
                            {"kind": "text",
                              "text": "♡"}]}],
                      "isInferred": true}]},
                {"kind": "mi",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0,
                    "mathvariant": "italic"},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "b"}]},
                {"kind": "mtext",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": " never"}],
                  "isSpacelike": true}],
              "isInferred": true},
            {"kind": "mi",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0,
                "mathvariant": "italic"},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": "c"}]},
            {"kind": "mtext",
              "texClass": 0,
              "attributes": {},
              "inherited": {"displaystyle": true,
                "scriptlevel": 0},
              "properties": {},
              "childNodes": [
                {"kind": "text",
                  "text": " never"}],
              "isSpacelike": true}],
          "isInferred": true},
        {"kind": "mi",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0,
            "mathvariant": "italic"},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": "d"}]},
        {"kind": "mtext",
          "texClass": 0,
          "attributes": {},
          "inherited": {"displaystyle": true,
            "scriptlevel": 0},
          "properties": {},
          "childNodes": [
            {"kind": "text",
              "text": " forever"}],
          "isSpacelike": true}],
      "isInferred": true}]}
);

parserTest.runTest(
  'Newenvironment Nested Error', '\\newenvironment{myHeartEnv}{\\color{purple}{\\heartsuit}\\kern-2.5pt\\color{green}{\\heartsuit}}{\\text{ forever}}\\newenvironment{yourHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\newenvironment{theirHeartEnv}{\\color{blue}{\\heartsuit}\\kern-2.5pt\\color{black}{\\heartsuit}}{\\text{ never}}\\begin{myHeartEnv}\\begin{yourHeartEnv}a\\begin{theirHeartEnv}b\\end{yourHeartEnv}\\end{theirHeartEnv}\\end{myHeartEnv}', 
  {"kind": "math",
   "texClass": 0,
   "attributes": {"display": "block"},
   "inherited": {"displaystyle": true,
                 "scriptlevel": 0},
   "properties": {},
   "childNodes": [
     {"kind": "mrow",
      "texClass": 0,
      "attributes": {},
      "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
      "properties": {},
      "childNodes": [
        {"kind": "merror",
         "texClass": 0,
         "attributes": {},
         "inherited": {"displaystyle": true,
                       "scriptlevel": 0},
         "properties": {},
         "childNodes": [
           {"kind": "mrow",
            "texClass": null,
            "attributes": {},
            "inherited": {"displaystyle": true,
                          "scriptlevel": 0},
            "properties": {},
            "childNodes": [
              {"kind": "mtext",
                  "texClass": 0,
                  "attributes": {},
                  "inherited": {"displaystyle": true,
                    "scriptlevel": 0},
                  "properties": {},
                  "childNodes": [
                    {"kind": "text",
                      "text": "\\begin{theirHeartEnv} ended with \\end{yourHeartEnv}"}],
                  "isSpacelike": true}],
              "isInferred": true,
              "isSpacelike": true}]}],
      "isInferred": true}]}
);


parserTest.printTime();
